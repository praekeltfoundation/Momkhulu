---
sudo: false
language: python
python:
  - "3.6"
cache: pip
services:
  - redis-server
env:
  - secure: "apfZZL+xk22IlmkyYEnCi6J475h/F+ffZ2epFzKq+I5VJUpgrzREX0zuDPRM5OON2mNkQnBWMIV0hFaj0c+lVZ++ZRHfKw70QvuFGb0EDX3fWq1nHakiWAxfeoA/1OooYB0peMS+ZxUBfyjoRSHh4HpqOYsUqQN1BZ61edIR0VAhKmOtiq+VjGahmhoqhTNVny43ka0F8z7BY8IWKaK4pBtjo3mNbBnABSTSqerFW/h37HtAEZhgarWkhwdGy18Jbz/L+0E3VSLanqIjzmHaitCFk5/Knw25Riv5incZtcvGZue/LnnpxSZLcMWwtx3hBz6mYB+Aa4APVQ10SgH3+E4WoB8G4XQZBknyljM0BUT+J8glPO6tF1dm4ID6ZbAVT5eFacyBOOb1IvIxBCT6KG9edNDgUv5m5oljwuFz8fIACQDX93CL+HamZF405SHNuyGTor6huwYr5hrwFvfR2SxXdGc2/D39oL2c283I39y4CZqGqTt2VoY7QS8qHmKLHfQpckHEbbP6ypJ+IeAQ6aJurmz8ebNVMlj2LYXpWZ0gZq54ro0JDLTlcIdcD2zTNwgvfUgm4+w9o4T7Is9/N9gP+GiUUe0ILGyEL1hghOLCba4QlQoA5YNwb8rCB3Ju6Q9V7FFH4z8AGf754qvw3tmgSNZOEO5+BqK91XVdhGo="   # yamllint disable-line
before_install:
  - pip install --upgrade pip
install:
  - pip install -r requirements.txt
  - pip install -r requirements-dev.txt
  - pip install codecov
script:
  - black --check .
  - flake8 .
  - py.test --cov=./
jobs:
  include:
    - stage: test
      python: "3.6"
      addons:
        postgresql: '9.4'
      services:
        - redis-server
        - postgresql
      # Clear unused build steps
      deploy: []
      after_success:
        - codecov
    - stage: docker
      python: "3.6"
      sudo: required
      dist: trusty
      services: [docker]
      env:
        - IMAGE_NAME=praekeltfoundation/momkhulu
        - REGISTRY_USER=praekeltorgdeploy
        - secure: "SgdU1fwW3exJhQqXnKGy5TdvMypkeutioMTIt4M9fUR5Chf/yftq9t2DTjBzuSYq7PCQMCVFzhZQxxC8D2xbjOtvW5LxLzY3q0k+ci8dXpnNLqq7sm9vWC2rqsZ70+aKTBcebaJtNG9EjpyPcC+JjdT0wpFq7dDMztTmHS0Htn7eMGmxNGxYI1LhiUpEQ9NPpMCvzWrkBOAH9T1+Mhn1wYaJaqc8fNogjfW5qmulhJL296jtF1NLomLYTYJyIRZxo2Lw1Z99KPZH095F6MB3O1EDpCGpFgQr8+8LN4m9f/DxaQ/Crj9iREBe516j86DDW/sUY26CvMbJxoHAyFLP7+sQXInIjihwRe7CtIn/o+8kPPRvaUbxPJ9cvBcnC//GBGF9K2LqwexU45Pa02B+R4NE9a+yLspXpu7MV0qDfMU2350v2uWyB7WTKK35xZPDxhfdEubHl0pNXnJ37hYW2AynTioxQ17idyj1ZRblUlNhbmIyqMDxov5BZKiJySS+4vQ1Y8GBbh+UAgr1mQlHVztSVwdiuN9vemFWRPu0XpsTtSMfgtWob+l4qFxuX0PzZaQIqRPfgkVDinwPSq4H2H7hSFOnLK+IVzusVUEX8vBP32hJtbvr/Z5pv9UGAuoFICyxZgZuIe78tNHwCxI3lTs5vYaWAELOY4bmPVO6/0Q="   # yamllint disable-line

      before_script:
        - docker pull "$IMAGE_NAME" || true
      script:
        - docker build --pull --tag "$IMAGE_NAME" .

      before_deploy:
        - pip install docker-ci-deploy==0.3.0
        - echo -n $REGISTRY_PASS | docker login -u "$REGISTRY_USER" --password-stdin # yamllint disable-line
      deploy:
        - provider: script
          script: dcd --version "$(git rev-parse --short HEAD)" --version-latest "$IMAGE_NAME" # yamllint disable-line
          on:
            branch: develop
        - provider: script
          script: dcd --tag "$TRAVIS_TAG" -- "$IMAGE_NAME"
          on:
            tags: true

      # Built steps inherited from the default stage that we don't want
      before_install: ignore
      after_success: []
